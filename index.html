<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-PROCESSOR V2.4 UNLOCKED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>

    <style>
        :root {
            --bg-dark: #080808;
            --panel-bg: #111111;
            --accent-orange: #f59e0b;
            --text-main: #cbd5e1;
            --border-col: #222222;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; overflow: hidden; user-select: none; }
        .tech-font { font-family: 'Share Tech Mono', monospace; }
        .industrial-panel { background: var(--panel-bg); border: 1px solid var(--border-col); position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }
        
        /* 裝飾性元素 */
        .screw { width: 6px; height: 6px; background: #2a2a2a; border-radius: 50%; position: absolute; box-shadow: inset 1px 1px 1px #000; }
        .screw-tl { top: 6px; left: 6px; } .screw-tr { top: 6px; right: 6px; }
        .screw-bl { bottom: 6px; left: 6px; } .screw-br { bottom: 6px; right: 6px; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: var(--accent-orange); border: 2px solid #000; cursor: pointer; margin-top: -6px; border-radius: 1px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #000; border: 1px solid #333; }

        .active-paragraph { background: rgba(245, 158, 11, 0.15); border-left: 4px solid var(--accent-orange); color: #fff; }
        .paragraph-item { padding: 14px; border-left: 4px solid transparent; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: 0.1s; }
        
        .hazard-stripe { background: repeating-linear-gradient(45deg, #000, #000 8px, #f59e0b 8px, #f59e0b 16px); height: 3px; width: 100%; opacity: 0.6; }
        
        textarea { background: #000000 !important; color: #f59e0b !important; border: 1px solid #222 !important; resize: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col p-4 box-border">

    <header class="flex justify-between items-center mb-4 industrial-panel p-4">
        <div class="screw screw-tl"></div><div class="screw screw-tr"></div>
        <div class="flex items-center gap-4">
            <div class="p-2 bg-amber-600 rounded-xs shadow-inner"><i class="fas fa-microchip text-black text-xl"></i></div>
            <div>
                <h1 class="text-xl font-black tech-font text-white tracking-widest">V-PROCESSOR <span class="text-amber-500">V2.4</span></h1>
                <p class="text-[9px] text-gray-600 tech-font">CORE_SIGNAL_EXTRACTOR_ACTIVE</p>
            </div>
        </div>
        <div id="clock" class="text-xs text-gray-700 tech-font">00:00:00</div>
    </header>

    <div class="flex-1 grid grid-cols-12 gap-4 min-h-0">
        <!-- 左側面板 -->
        <div class="col-span-8 flex flex-col gap-4 min-h-0">
            <div class="h-1/3 industrial-panel flex flex-col min-h-0">
                <div class="bg-black/50 px-3 py-1 flex justify-between items-center border-b border-white/5">
                    <span class="text-[10px] text-gray-500 tech-font">SOURCE_BUFFER</span>
                    <button onclick="processText()" class="text-[10px] text-amber-500 font-bold hover:bg-amber-500 hover:text-black px-2 transition">SYNC_DATA</button>
                </div>
                <textarea id="txtInput" class="flex-1 p-4 font-mono text-sm leading-relaxed" placeholder="請在此輸入文字序列..."></textarea>
            </div>
            <div class="h-2/3 industrial-panel flex flex-col min-h-0">
                <div id="listContainer" class="flex-1 overflow-y-auto font-mono no-scrollbar bg-black/5"></div>
                <div class="screw screw-bl"></div><div class="screw screw-br"></div>
            </div>
        </div>

        <!-- 右側面板 -->
        <div class="col-span-4 flex flex-col gap-4">
            <div class="industrial-panel p-5">
                <h3 class="text-[10px] text-amber-500 tech-font mb-4 border-b border-amber-900/40 pb-1">PROCESS_CONFIG</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">VOICE_UNIT</label>
                        <select id="vSelect" class="w-full bg-black border border-neutral-800 text-xs p-2 text-amber-400 focus:outline-none"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-500 block mb-1">RATE (<span id="rV">1.0</span>)</label>
                            <input type="range" id="rR" min="0.5" max="2" step="0.1" value="1.0">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-500 block mb-1">PITCH (<span id="pV">1.0</span>)</label>
                            <input type="range" id="pR" min="0.5" max="1.5" step="0.1" value="1.0">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">SIGNAL_GAP (<span id="gV">0.5</span>s)</label>
                        <input type="range" id="gR" min="0" max="3" step="0.1" value="0.5">
                    </div>
                </div>
            </div>

            <div class="industrial-panel p-5 flex-1 flex flex-col">
                <div class="hazard-stripe mb-6"></div>
                <div class="space-y-3 flex-1 flex flex-col justify-center">
                    <button id="pBtn" class="w-full bg-neutral-800 hover:bg-neutral-700 text-white font-bold py-4 rounded-xs border border-white/5 transition flex items-center justify-center gap-3">
                        <i class="fas fa-play text-xs text-amber-500"></i> PREVIEW
                    </button>
                    
                    <!-- 主要錄製按鈕 -->
                    <button id="rBtn" class="w-full bg-amber-600 hover:bg-amber-500 text-black font-black py-5 rounded-xs shadow-lg transition flex flex-col items-center">
                        <div class="flex items-center gap-2"><i id="rI" class="fas fa-record-vinyl"></i> EXECUTE_INTERNAL_CAPTURE</div>
                        <span class="text-[8px] mt-1 opacity-70">BYPASS SYSTEM RESTRICTION</span>
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="sBtn" class="bg-neutral-900 text-[10px] py-2 text-gray-500 hover:text-red-500 uppercase tech-font border border-white/5">Stop</button>
                        <button id="pauseBtn" class="bg-neutral-900 text-[10px] py-2 text-gray-500 hover:text-white uppercase tech-font border border-white/5">Pause</button>
                    </div>
                </div>

                <div class="mt-4 bg-black/80 p-3 border border-amber-900/20">
                    <div id="stInd" class="text-[9px] text-amber-500 tech-font">SYS_STATUS: READY</div>
                    <div id="prTxt" class="text-[10px] text-emerald-500 tech-font truncate uppercase tracking-tighter">Standby...</div>
                </div>
                <div class="screw screw-bl"></div><div class="screw screw-br"></div>
            </div>
        </div>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let voices = [], paragraphs = [], currentIndex = 0, isPlaying = false, isRecording = false;
        let gapTimeout = null, mp3Data = [], audioCtx, source, processor, mp3encoder, stream;

        // 設定
        document.addEventListener('contextmenu', e => e.preventDefault());
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-TW', {hour12:false}); }, 1000);

        const sync = (id, tid) => {
            document.getElementById(id).oninput = (e) => { document.getElementById(tid).innerText = e.target.value; };
        };
        sync('rR', 'rV'); sync('pR', 'pV'); sync('gR', 'gV');

        function initVoices() {
            voices = synth.getVoices();
            const sel = document.getElementById('vSelect');
            if(!sel) return;
            sel.innerHTML = '';
            voices.filter(v => v.lang.includes('zh') || v.lang.includes('TW')).forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = v.name;
                sel.appendChild(opt);
            });
        }
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = initVoices;
        initVoices();

        function processText() {
            const raw = document.getElementById('txtInput').value.trim();
            if(!raw) return;
            paragraphs = raw.split(/\n+/).filter(p => p.trim());
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            paragraphs.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'paragraph-item text-gray-500';
                d.innerHTML = `<span class="opacity-20 mr-4 tech-font text-xs">${String(i+1).padStart(3,'0')}</span>${p}`;
                d.onclick = () => { currentIndex = i; updateHighlight(); };
                container.appendChild(d);
            });
            currentIndex = 0;
            updateHighlight();
            document.getElementById('prTxt').innerText = 'MEMORY_SYNC_OK';
        }

        function updateHighlight() {
            document.querySelectorAll('.paragraph-item').forEach((el, i) => {
                el.classList.toggle('active-paragraph', i === currentIndex);
                if(i === currentIndex) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }

        function speak() {
            if (currentIndex >= paragraphs.length) {
                if(isRecording) endRecording();
                resetSystem();
                document.getElementById('prTxt').innerText = 'SEQUENCE_COMPLETE';
                return;
            }
            updateHighlight();
            const utt = new SpeechSynthesisUtterance(paragraphs[currentIndex]);
            const vIndex = document.getElementById('vSelect').value;
            const vList = voices.filter(v => v.lang.includes('zh') || v.lang.includes('TW'));
            utt.voice = vList[vIndex] || voices[0];
            utt.rate = parseFloat(document.getElementById('rR').value);
            utt.pitch = parseFloat(document.getElementById('pR').value);
            utt.onstart = () => { document.getElementById('prTxt').innerText = `SENDING_P${currentIndex+1}`; };
            utt.onend = () => {
                if(!isPlaying) return;
                const delay = parseFloat(document.getElementById('gR').value) * 1000;
                gapTimeout = setTimeout(() => { currentIndex++; speak(); }, delay);
            };
            synth.speak(utt);
        }

        function resetSystem() {
            synth.cancel();
            clearTimeout(gapTimeout);
            isPlaying = false;
            document.getElementById('stInd').innerText = 'SYS_STATUS: IDLE';
        }

        // 核心錄音邏輯
        document.getElementById('rBtn').onclick = async () => {
            if (isRecording) {
                endRecording();
                resetSystem();
            } else {
                if(paragraphs.length === 0) return alert("請先輸入文字資料");
                
                try {
                    // 嘗試擷取「系統/分頁」音訊 (這是目前 Web 能做到的極限)
                    // 注意：在某些沙盒環境下仍會報 Permission Error，請在本機獨立打開此 HTML
                    stream = await navigator.mediaDevices.getDisplayMedia({ 
                        video: { displaySurface: "browser" }, // 請求選擇分頁
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });

                    // 檢查用戶是否有選擇分享音訊
                    if (stream.getAudioTracks().length === 0) {
                        stream.getTracks().forEach(t => t.stop());
                        alert("錄製失敗：請在選擇視窗中勾選「分享分頁音訊」！");
                        return;
                    }

                    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
                    source = audioCtx.createMediaStreamSource(stream);
                    processor = audioCtx.createScriptProcessor(4096, 1, 1);
                    mp3encoder = new lamejs.Mp3Encoder(1, 44100, 128);
                    mp3Data = [];

                    processor.onaudioprocess = (e) => {
                        const buffer = e.inputBuffer.getChannelData(0);
                        const samples = new Int16Array(buffer.length);
                        for (let i = 0; i < buffer.length; i++) {
                            let s = Math.max(-1, Math.min(1, buffer[i]));
                            samples[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        const mp3 = mp3encoder.encodeBuffer(samples);
                        if(mp3.length > 0) mp3Data.push(mp3);
                    };

                    source.connect(processor);
                    processor.connect(audioCtx.destination);

                    isRecording = true;
                    isPlaying = true;
                    currentIndex = 0;
                    document.getElementById('stInd').innerText = 'SYS_STATUS: RECORDING';
                    document.getElementById('rI').className = 'fas fa-stop-circle text-red-500 animate-pulse';
                    speak();

                } catch (err) {
                    console.error(err);
                    alert("權限錯誤：在目前的預覽環境中，「系統音訊擷取」被封鎖。\n\n請下載此 HTML 並在本機電腦打開，即可正常選擇『分頁音訊』進行內錄！");
                }
            }
        };

        function endRecording() {
            if(!isRecording) return;
            const last = mp3encoder.flush();
            if(last.length > 0) mp3Data.push(last);
            const blob = new Blob(mp3Data, { type: 'audio/mp3' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `V_INTERNAL_${Date.now()}.mp3`;
            link.click();

            if(processor) processor.disconnect();
            if(source) source.disconnect();
            if(audioCtx) audioCtx.close();
            if(stream) stream.getTracks().forEach(t => t.stop());
            isRecording = false;
            document.getElementById('rI').className = 'fas fa-record-vinyl';
        }

        document.getElementById('pBtn').onclick = () => {
            resetSystem();
            isPlaying = true;
            currentIndex = 0;
            document.getElementById('stInd').innerText = 'SYS_STATUS: PREVIEW';
            speak();
        };

        document.getElementById('sBtn').onclick = resetSystem;
        document.getElementById('pauseBtn').onclick = () => {
            if(synth.speaking) {
                if(synth.paused) { synth.resume(); } else { synth.pause(); }
            }
        };
    </script>
</body>
</html>